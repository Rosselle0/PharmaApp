generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id              String           @id @default(uuid())
  name            String
  createdAt       DateTime         @default(now())
  employees       Employee[]
  taskAssignments TaskAssignment[]
  taskTemplates   TaskTemplate[]
  users           User[]
}

model User {
  id               String            @id @default(uuid())
  authUserId       String            @unique
  email            String            @unique
  role             Role              @default(EMPLOYEE)
  companyId        String
  createdAt        DateTime          @default(now())
  name             String?
  department       Department        @default(FLOOR)
  employeeNumber   Int?
  punchEvents      PunchEvent[]
  timeOffs         TimeOff[]
  company          Company           @relation(fields: [companyId], references: [id])
  vacationRequests VacationRequest[]

  @@unique([companyId, employeeNumber])
  @@index([companyId])
  @@index([companyId, department])
}

model Employee {
  id           String @id @default(uuid())
  companyId    String
  firstName    String
  lastName     String
  employeeCode String @unique

  role       Role       @default(EMPLOYEE) // <-- AJOUTE ÇA
  department Department @default(FLOOR) // <-- GARDE ÇA (Option A)

  paidBreak30 Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company         Company              @relation(fields: [companyId], references: [id])
  shifts          Shift[]
  TaskAssignment  TaskAssignment[]
  recurringRules  RecurringShiftRule[]
  VacationRequest VacationRequest[]

  @@index([companyId])
  @@index([companyId, department])
}

model VacationRequest {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  status    VacationStatus @default(PENDING)
  reason    String?

  decidedAt       DateTime?
  decidedByUserId String?
  decidedByUser   User?     @relation(fields: [decidedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shifts  Shift[]
  TimeOff TimeOff?

  @@index([employeeId, status])
  @@index([startDate, endDate])
}

model TimeOff {
  id        String           @id @default(uuid())
  userId    String
  startDate DateTime
  endDate   DateTime
  type      TimeOffType      @default(VACATION)
  requestId String?          @unique
  createdAt DateTime         @default(now())
  request   VacationRequest? @relation(fields: [requestId], references: [id])
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId, startDate])
  @@index([startDate, endDate])
}

model PunchEvent {
  id        String      @id @default(uuid())
  userId    String
  shiftId   String?
  type      PunchType
  at        DateTime
  source    PunchSource @default(MOBILE)
  createdAt DateTime    @default(now())
  shift     Shift?      @relation(fields: [shiftId], references: [id])
  user      User        @relation(fields: [userId], references: [id])

  @@index([userId, at])
  @@index([shiftId])
}

model AuditLog {
  id        String   @id @default(uuid())
  actorId   String?
  action    String
  target    String
  createdAt DateTime @default(now())
  companyId String?
  meta      Json?

  @@index([companyId, createdAt])
  @@index([actorId, createdAt])
}

model TaskTemplate {
  id        String             @id @default(uuid())
  companyId String
  title     String
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  notes     String?
  company   Company            @relation(fields: [companyId], references: [id])
  items     TaskTemplateItem[]

  @@index([companyId])
}

model TaskTemplateItem {
  id         String       @id @default(uuid())
  templateId String
  text       String
  required   Boolean      @default(true)
  order      Int
  template   TaskTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

model TaskAssignment {
  id         String               @id @default(uuid())
  companyId  String
  employeeId String
  date       DateTime
  title      String?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  notes      String?
  company    Company              @relation(fields: [companyId], references: [id])
  employee   Employee             @relation(fields: [employeeId], references: [id])
  items      TaskAssignmentItem[]

  @@index([companyId, date])
  @@index([employeeId, date])
}

model TaskAssignmentItem {
  id           String         @id @default(uuid())
  assignmentId String
  order        Int
  text         String
  required     Boolean        @default(true)
  done         Boolean        @default(false)
  doneAt       DateTime?
  assignment   TaskAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
}

enum Department {
  CASH
  LAB
  FLOOR
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum VacationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum TimeOffType {
  VACATION
  SICK
  UNPAID
  OTHER
}

enum ShiftStatus {
  PLANNED
  ON_LEAVE
  COMPLETED
  CANCELED
}

enum PunchType {
  IN
  OUT
  BREAK_START
  BREAK_END
}

enum PunchSource {
  MOBILE
  WEB
  ADMIN
}

enum ShiftSource {
  MANUAL
  RECURRING
}

model RecurringShiftRule {
  id         String    @id @default(uuid())
  employeeId String
  dayOfWeek  Int // 0=Sun ... 6=Sat
  startHHMM  String // "08:00"
  endHHMM    String // "17:00"
  note       String?
  active     Boolean   @default(true)
  locked     Boolean   @default(false)
  startsOn   DateTime  @default(now())
  endsOn     DateTime?

  employee Employee @relation(fields: [employeeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Shift     Shift[]

  @@unique([employeeId, dayOfWeek])
  @@index([employeeId])
}

model Shift {
  id        String      @id @default(uuid())
  startTime DateTime
  endTime   DateTime
  status    ShiftStatus @default(PLANNED)
  note      String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  employeeId  String
  punchEvents PunchEvent[]
  employee    Employee     @relation(fields: [employeeId], references: [id])

  source ShiftSource         @default(MANUAL)
  ruleId String?
  rule   RecurringShiftRule? @relation(fields: [ruleId], references: [id])

  vacationRequestId String?
  vacationRequest   VacationRequest? @relation(fields: [vacationRequestId], references: [id], onDelete: SetNull)

  @@index([employeeId, startTime])
  @@index([startTime, endTime])
  @@index([ruleId])
}
